<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <title>Configure orchestrated scans - Soda Documentation</title> <link rel="shortcut icon" href="/soda-sql/favicon.ico" type="image/x-icon"> <link rel="stylesheet" href="/soda-sql/assets/css/just-the-docs-default.css"> <script type="text/javascript" src="/soda-sql/assets/js/vendor/lunr.min.js"></script> <script type="text/javascript" src="/soda-sql/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.7.1 --> <title>Configure orchestrated scans | Soda Documentation</title> <meta name="generator" content="Jekyll v4.2.0" /> <meta property="og:title" content="Configure orchestrated scans" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Learn how to use Soda to test and monitor data quality." /> <meta property="og:description" content="Learn how to use Soda to test and monitor data quality." /> <link rel="canonical" href="/soda-sql/documentation/orchestrate_scans.html" /> <meta property="og:url" content="/soda-sql/documentation/orchestrate_scans.html" /> <meta property="og:site_name" content="Soda Documentation" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="Configure orchestrated scans" /> <script type="application/ld+json"> {"url":"/soda-sql/documentation/orchestrate_scans.html","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"/soda-sql/assets/images/soda-logo.svg"}},"description":"Learn how to use Soda to test and monitor data quality.","@type":"WebPage","headline":"Configure orchestrated scans","@context":"https://schema.org"}</script> <!-- End Jekyll SEO tag --> </head> <body> <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header"> <a href="/soda-sql/" class="site-title lh-tight"> <div class="site-logo"></div> </a> <a href="#" id="menu-button" class="site-button"> <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a> </div> <nav role="navigation" aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"> <li class="nav-list-item "> <a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"> <use xlink:href="#svg-arrow-right"></use> </svg></a> <a class="nav-list-link" href="/soda-sql/getting-started/5_min_tutorial.html">Get Started</a> <ul class="nav-list "> <li class="nav-list-item"> <a class="nav-list-link " href="/soda-sql/getting-started/5_min_tutorial.html">Quick start tutorial</a> </li> <li class="nav-list-item"> <a class="nav-list-link " href="/soda-sql/getting-started/installation.html">Install Soda SQL</a> </li> <li class="nav-list-item"> <a class="nav-list-link " href="/soda-sql/getting-started/configure.html">Configure Soda SQL</a> </li> </ul> </li> <li class="nav-list-item active"> <a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"> <use xlink:href="#svg-arrow-right"></use> </svg></a> <a class="nav-list-link" href="/soda-sql/documentation/concepts.html">Documentation</a> <ul class="nav-list "> <li class="nav-list-item"> <a class="nav-list-link " href="/soda-sql/documentation/concepts.html">How Soda SQL works</a> </li> <li class="nav-list-item"> <a class="nav-list-link " href="/soda-sql/documentation/cli.html">Soda SQL CLI commands</a> </li> <li class="nav-list-item"> <a class="nav-list-link " href="/soda-sql/documentation/warehouse.html">Warehouse YAML</a> </li> <li class="nav-list-item"> <a class="nav-list-link " href="/soda-sql/documentation/warehouse_types.html">Set warehouse configuration</a> </li> <li class="nav-list-item"> <a class="nav-list-link " href="/soda-sql/documentation/scan.html">Scan YAML</a> </li> <li class="nav-list-item"> <a class="nav-list-link " href="/soda-sql/documentation/sql_metrics.html">Metrics</a> </li> <li class="nav-list-item"> <a class="nav-list-link " href="/soda-sql/documentation/tests.html">Tests</a> </li> <li class="nav-list-item"> <a class="nav-list-link " href="/soda-sql/documentation/filtering.html">Apply filters</a> </li> <li class="nav-list-item"> <a class="nav-list-link " href="/soda-sql/documentation/programmatic_scan.html">Configure programmatic scans</a> </li> <li class="nav-list-item"> <a class="nav-list-link active" href="/soda-sql/documentation/orchestrate_scans.html">Configure orchestrated scans</a> </li> <li class="nav-list-item"> <a class="nav-list-link " href="/soda-sql/documentation/soda-cloud-architecture.html">Soda Cloud Architecture</a> </li> <li class="nav-list-item"> <a class="nav-list-link " href="/soda-sql/documentation/connect_to_cloud.html">Connect to Soda Cloud</a> </li> <li class="nav-list-item"> <a class="nav-list-link " href="/soda-sql/documentation/monitors.html">Create monitors and alerts</a> </li> <li class="nav-list-item"> <a class="nav-list-link " href="/soda-sql/documentation/integrate-slack.html">Integrate with Slack</a> </li> <li class="nav-list-item"> <a class="nav-list-link " href="/soda-sql/documentation/troubleshoot.html">Troubleshoot</a> </li> <li class="nav-list-item"> <a class="nav-list-link " href="/soda-sql/documentation/glossary.html">Glossary</a> </li> </ul> </li> <li class="nav-list-item"> <a class="nav-list-link " href="/soda-sql/community.html">Community</a> </li> </ul> </nav> <footer class="site-footer"> This site uses <a href="https://github.com/pmarsceill/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. </footer> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search Soda Documentation" aria-label="Search Soda Documentation" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> <nav aria-label="Auxiliary" class="aux-nav"> <ul class="aux-nav-list"> <li class="aux-nav-list-item"> <a href="//github.com/sodadata/soda-sql" class="site-button" > Soda SQL on GitHub </a> </li> </ul> </nav> </div> <div id="main-content-wrap" class="main-content-wrap"> <nav aria-label="Breadcrumb" class="breadcrumb-nav"> <ol class="breadcrumb-nav-list"> <li class="breadcrumb-nav-list-item"><a href="">Documentation</a></li> <li class="breadcrumb-nav-list-item"><span>Configure orchestrated scans</span></li> </ol> </nav> <div id="main-content" class="main-content" role="main"> <h1 id="configure-orchestrated-scans"> <a href="#configure-orchestrated-scans" class="anchor-heading" aria-labelledby="configure-orchestrated-scans"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Configure orchestrated scans </h1> <p>Integrate Soda SQL with a <strong>data orchestration tool</strong> such as, Airflow, Dagster, or dbt, to automate and schedule your search for “bad” data.</p> <p>Not only can you schedule <a href="/soda-sql/documentation/glossary.html#scan">scans</a> of <a href="/soda-sql/documentation/glossary.html#warehouse">warehouse</a> <a href="/soda-sql/documentation/glossary.html#table">tables</a>, you can also configure actions that the orchestration tool can take based on scan output. For example, if the output of a scan reveals a large number of failed tests, the orchestration tool can automatically block “bad” data from contaminating your data pipeline.</p> <p>Use the results of a Soda SQL scan to instruct your orchestration tool to:</p> <ul> <li>block “bad” data from entering your data pipeline (for testing), or,</li> <li>allow data to enter the pipeline (for monitoring).</li> </ul> <p><img src="../assets/images/orchestrate.png" alt="orchestrate" height="800px" width="800px" /></p> <p>Follow the instructions that correspond to your data orchestration tool:</p> <p><a href="#apache-airflow-using-pythonvirtualenvoperator">Apache Airflow using PythonVirtualenvOperator</a><br /> <a href="#apache-airflow-using-pythonoperator">Apache Airflow using PythonOperator</a><br /> <a href="#apache-airflow-using-bashoperator">Apache Airflow using BashOperator</a><br /> <a href="#prefect-using-a-custom-task">Prefect using a custom Task</a><br /> More coming soon <br /></p> <h2 id="apache-airflow-using-pythonvirtualenvoperator"> <a href="#apache-airflow-using-pythonvirtualenvoperator" class="anchor-heading" aria-labelledby="apache-airflow-using-pythonvirtualenvoperator"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Apache Airflow using PythonVirtualenvOperator </h2> <p>Though you can install Soda SQL directly in your Airflow environment, the instructions below use PythonVirtualenvOperator to run Soda SQL scans in a different environment. This keeps Soda SQL software separate to prevent any dependency conflicts.</p> <ol> <li>Install <code class="language-plaintext highlighter-rouge">virtualenv</code> in your main Airflow environment.</li> <li>Set the following variables in your Airflow environment. <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">warehouse_yml</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'soda_sql_warehouse_yml_path'</span><span class="p">)</span>
<span class="n">scan_yml</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'soda_sql_scan_yml_path'</span><span class="p">)</span>
</code></pre></div> </div> </li> <li>Configure as per the following example.</li> </ol> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">airflow</span> <span class="kn">import</span> <span class="n">DAG</span>
<span class="kn">from</span> <span class="nn">airflow.models.variable</span> <span class="kn">import</span> <span class="n">Variable</span>
<span class="kn">from</span> <span class="nn">airflow.operators.python</span> <span class="kn">import</span> <span class="n">PythonVirtualenvOperator</span>
<span class="kn">from</span> <span class="nn">airflow.operators.dummy</span> <span class="kn">import</span> <span class="n">DummyOperator</span>
<span class="kn">from</span> <span class="nn">airflow.utils.dates</span> <span class="kn">import</span> <span class="n">days_ago</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">timedelta</span>

<span class="n">default_args</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">'owner'</span><span class="p">:</span> <span class="s">'soda_sql'</span><span class="p">,</span>
    <span class="s">'retries'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s">'retry_delay'</span><span class="p">:</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">5</span><span class="p">),</span>
<span class="p">}</span>


<span class="k">def</span> <span class="nf">run_soda_scan</span><span class="p">(</span><span class="n">warehouse_yml_file</span><span class="p">,</span> <span class="n">scan_yml_file</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">sodasql.scan.scan_builder</span> <span class="kn">import</span> <span class="n">ScanBuilder</span>
    <span class="n">scan_builder</span> <span class="o">=</span> <span class="n">ScanBuilder</span><span class="p">()</span>
    <span class="c1"># Optionally you can directly build the warehouse dict from Airflow secrets/variables
</span>    <span class="c1"># and set scan_builder.warehouse_dict with values.
</span>    <span class="n">scan_builder</span><span class="p">.</span><span class="n">warehouse_yml_file</span> <span class="o">=</span> <span class="n">warehouse_yml_file</span>
    <span class="n">scan_builder</span><span class="p">.</span><span class="n">scan_yml_file</span> <span class="o">=</span> <span class="n">scan_yml_file</span>
    <span class="n">scan</span> <span class="o">=</span> <span class="n">scan_builder</span><span class="p">.</span><span class="n">build</span><span class="p">()</span>
    <span class="n">scan_result</span> <span class="o">=</span> <span class="n">scan</span><span class="p">.</span><span class="n">execute</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">scan_result</span><span class="p">.</span><span class="n">has_test_failures</span><span class="p">():</span>
        <span class="n">failures</span> <span class="o">=</span> <span class="n">scan_result</span><span class="p">.</span><span class="n">get_test_failures_count</span><span class="p">()</span>
        <span class="k">raise</span> <span class="nb">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s">"Soda Scan found </span><span class="si">{</span><span class="n">failures</span><span class="si">}</span><span class="s"> errors in your data!"</span><span class="p">)</span>


<span class="n">dag</span> <span class="o">=</span> <span class="n">DAG</span><span class="p">(</span>
    <span class="s">'soda_sql_python_venv_op'</span><span class="p">,</span>
    <span class="n">default_args</span><span class="o">=</span><span class="n">default_args</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="s">'A simple Soda SQL scan DAG'</span><span class="p">,</span>
    <span class="n">schedule_interval</span><span class="o">=</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
    <span class="n">start_date</span><span class="o">=</span><span class="n">days_ago</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
<span class="p">)</span>

<span class="n">ingest_data_op</span> <span class="o">=</span> <span class="n">DummyOperator</span><span class="p">(</span>
    <span class="n">task_id</span><span class="o">=</span><span class="s">'ingest_data'</span>
<span class="p">)</span>

<span class="n">soda_sql_scan_op</span> <span class="o">=</span> <span class="n">PythonVirtualenvOperator</span><span class="p">(</span>
    <span class="n">task_id</span><span class="o">=</span><span class="s">'soda_sql_scan_demodata'</span><span class="p">,</span>
    <span class="n">python_callable</span><span class="o">=</span><span class="n">run_soda_scan</span><span class="p">,</span>
    <span class="n">requirements</span><span class="o">=</span><span class="p">[</span><span class="s">"soda-sql==2.0.0b10"</span><span class="p">],</span>
    <span class="n">system_site_packages</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
    <span class="n">op_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s">'warehouse_yml_file'</span><span class="p">:</span> <span class="n">warehouse_yml</span><span class="p">,</span>
               <span class="s">'scan_yml_file'</span><span class="p">:</span> <span class="n">scan_yml</span><span class="p">},</span>
    <span class="n">dag</span><span class="o">=</span><span class="n">dag</span>
<span class="p">)</span>

<span class="n">publish_data_op</span> <span class="o">=</span> <span class="n">DummyOperator</span><span class="p">(</span>
    <span class="n">task_id</span><span class="o">=</span><span class="s">'publish_data'</span>
<span class="p">)</span>

<span class="n">ingest_data_op</span> <span class="o">&gt;&gt;</span> <span class="n">soda_sql_scan_op</span> <span class="o">&gt;&gt;</span> <span class="n">publish_data_op</span>

</code></pre></div></div> <h2 id="apache-airflow-using-pythonoperator"> <a href="#apache-airflow-using-pythonoperator" class="anchor-heading" aria-labelledby="apache-airflow-using-pythonoperator"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Apache Airflow using PythonOperator </h2> <p>If you do not want to use a PythonVirtualenvOperator, which installs Soda SQL on invocation, you can use PythonOperator.</p> <ol> <li>Set the following variables in your Airflow environment. <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">warehouse_yml</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'soda_sql_warehouse_yml_path'</span><span class="p">)</span>
<span class="n">scan_yml</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'soda_sql_scan_yml_path'</span><span class="p">)</span>
</code></pre></div> </div> </li> <li>Configure as per the following example.</li> </ol> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">airflow</span> <span class="kn">import</span> <span class="n">DAG</span>
<span class="kn">from</span> <span class="nn">airflow.models.variable</span> <span class="kn">import</span> <span class="n">Variable</span>
<span class="kn">from</span> <span class="nn">airflow.operators.python</span> <span class="kn">import</span> <span class="n">PythonOperator</span>
<span class="kn">from</span> <span class="nn">airflow.operators.dummy</span> <span class="kn">import</span> <span class="n">DummyOperator</span>
<span class="kn">from</span> <span class="nn">airflow.utils.dates</span> <span class="kn">import</span> <span class="n">days_ago</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">sodasql.scan.scan_builder</span> <span class="kn">import</span> <span class="n">ScanBuilder</span>
<span class="kn">from</span> <span class="nn">airflow.exceptions</span> <span class="kn">import</span> <span class="n">AirflowFailException</span>

<span class="c1"># Make sure that this variables are set in your Airflow
</span><span class="n">warehouse_yml</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'soda_sql_warehouse_yml_path'</span><span class="p">)</span>
<span class="n">scan_yml</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'soda_sql_scan_yml_path'</span><span class="p">)</span>

<span class="n">default_args</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">'owner'</span><span class="p">:</span> <span class="s">'soda_sql'</span><span class="p">,</span>
    <span class="s">'retries'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s">'retry_delay'</span><span class="p">:</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">5</span><span class="p">),</span>
<span class="p">}</span>


<span class="k">def</span> <span class="nf">run_soda_scan</span><span class="p">(</span><span class="n">warehouse_yml_file</span><span class="p">,</span> <span class="n">scan_yml_file</span><span class="p">):</span>
    <span class="n">scan_builder</span> <span class="o">=</span> <span class="n">ScanBuilder</span><span class="p">()</span>
    <span class="n">scan_builder</span><span class="p">.</span><span class="n">warehouse_yml_file</span> <span class="o">=</span> <span class="n">warehouse_yml_file</span>
    <span class="n">scan_builder</span><span class="p">.</span><span class="n">scan_yml_file</span> <span class="o">=</span> <span class="n">scan_yml_file</span>
    <span class="n">scan</span> <span class="o">=</span> <span class="n">scan_builder</span><span class="p">.</span><span class="n">build</span><span class="p">()</span>
    <span class="n">scan_result</span> <span class="o">=</span> <span class="n">scan</span><span class="p">.</span><span class="n">execute</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">scan_result</span><span class="p">.</span><span class="n">has_test_failures</span><span class="p">():</span>
        <span class="n">failures</span> <span class="o">=</span> <span class="n">scan_result</span><span class="p">.</span><span class="n">get_test_failures_count</span><span class="p">()</span>
        <span class="k">raise</span> <span class="n">AirflowFailException</span><span class="p">(</span><span class="sa">f</span><span class="s">"Soda Scan found </span><span class="si">{</span><span class="n">failures</span><span class="si">}</span><span class="s"> errors in your data!"</span><span class="p">)</span>


<span class="n">dag</span> <span class="o">=</span> <span class="n">DAG</span><span class="p">(</span>
    <span class="s">'soda_sql_python_op'</span><span class="p">,</span>
    <span class="n">default_args</span><span class="o">=</span><span class="n">default_args</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="s">'A simple Soda SQL scan DAG'</span><span class="p">,</span>
    <span class="n">schedule_interval</span><span class="o">=</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
    <span class="n">start_date</span><span class="o">=</span><span class="n">days_ago</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
<span class="p">)</span>

<span class="n">ingest_data_op</span> <span class="o">=</span> <span class="n">DummyOperator</span><span class="p">(</span>
    <span class="n">task_id</span><span class="o">=</span><span class="s">'ingest_data'</span>
<span class="p">)</span>

<span class="n">soda_sql_scan_op</span> <span class="o">=</span> <span class="n">PythonOperator</span><span class="p">(</span>
    <span class="n">task_id</span><span class="o">=</span><span class="s">'soda_sql_scan_demodata'</span><span class="p">,</span>
    <span class="n">python_callable</span><span class="o">=</span><span class="n">run_soda_scan</span><span class="p">,</span>
    <span class="n">op_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s">'warehouse_yml_file'</span><span class="p">:</span> <span class="n">warehouse_yml</span><span class="p">,</span>
               <span class="s">'scan_yml_file'</span><span class="p">:</span> <span class="n">scan_yml</span><span class="p">},</span>
    <span class="n">dag</span><span class="o">=</span><span class="n">dag</span>
<span class="p">)</span>

<span class="n">publish_data_op</span> <span class="o">=</span> <span class="n">DummyOperator</span><span class="p">(</span>
    <span class="n">task_id</span><span class="o">=</span><span class="s">'publish_data'</span>
<span class="p">)</span>

<span class="n">ingest_data_op</span> <span class="o">&gt;&gt;</span> <span class="n">soda_sql_scan_op</span> <span class="o">&gt;&gt;</span> <span class="n">publish_data_op</span>

</code></pre></div></div> <h2 id="apache-airflow-using-bashoperator"> <a href="#apache-airflow-using-bashoperator" class="anchor-heading" aria-labelledby="apache-airflow-using-bashoperator"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Apache Airflow using BashOperator </h2> <p>Invoke a Soda SQL scan using Airflow BashOperator.</p> <ol> <li>Install Soda SQL in your Airflow environment.</li> <li>Set the following variables in your Airflow environment. <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">warehouse_yml</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'soda_sql_warehouse_yml_path'</span><span class="p">)</span>
<span class="n">scan_yml</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'soda_sql_scan_yml_path'</span><span class="p">)</span>
</code></pre></div> </div> </li> <li>Configure as per the following example.</li> </ol> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># In this  DAG, the `soda_sql_scan_demodata` task fails when the tests you
# defined for the `demodata` table fail. This prevents the `publish_data_op` from
# running. You can further customize the bash command to use different Soda SQL command
# options, such as passing variables to the `soda scan` command.
</span>
<span class="kn">from</span> <span class="nn">airflow</span> <span class="kn">import</span> <span class="n">DAG</span>
<span class="kn">from</span> <span class="nn">airflow.models.variable</span> <span class="kn">import</span> <span class="n">Variable</span>
<span class="kn">from</span> <span class="nn">airflow.operators.bash</span> <span class="kn">import</span> <span class="n">BashOperator</span>
<span class="kn">from</span> <span class="nn">airflow.operators.dummy</span> <span class="kn">import</span> <span class="n">DummyOperator</span>
<span class="kn">from</span> <span class="nn">airflow.utils.dates</span> <span class="kn">import</span> <span class="n">days_ago</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">timedelta</span>

<span class="c1"># Use the same variable name that you used when you set your Airflow variables
</span><span class="n">soda_sql_project_path</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">'soda_sql_project_path'</span><span class="p">)</span>

<span class="n">default_args</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">'owner'</span><span class="p">:</span> <span class="s">'soda_sql'</span><span class="p">,</span>
    <span class="s">'retries'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s">'retry_delay'</span><span class="p">:</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">5</span><span class="p">),</span>
<span class="p">}</span>

<span class="n">dag</span> <span class="o">=</span> <span class="n">DAG</span><span class="p">(</span>
    <span class="s">'soda_sql_scan'</span><span class="p">,</span>
    <span class="n">default_args</span><span class="o">=</span><span class="n">default_args</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="s">'A simple Soda SQL scan DAG'</span><span class="p">,</span>
    <span class="n">schedule_interval</span><span class="o">=</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
    <span class="n">start_date</span><span class="o">=</span><span class="n">days_ago</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
<span class="p">)</span>
<span class="c1"># A dummy operator to simulate data ingestion
</span><span class="n">ingest_data_op</span> <span class="o">=</span> <span class="n">DummyOperator</span><span class="p">(</span>
    <span class="n">task_id</span><span class="o">=</span><span class="s">'ingest_data'</span>
<span class="p">)</span>

<span class="c1"># Soda SQL Scan which runs the appropriate table scan for the ingestion
</span><span class="n">soda_sql_scan_op</span> <span class="o">=</span> <span class="n">BashOperator</span><span class="p">(</span>
    <span class="n">task_id</span><span class="o">=</span><span class="s">'soda_sql_scan_demodata'</span><span class="p">,</span>
    <span class="n">bash_command</span><span class="o">=</span><span class="sa">f</span><span class="s">'cd </span><span class="si">{</span><span class="n">soda_sql_project_path</span><span class="si">}</span><span class="s"> &amp;&amp; soda scan warehouse.yml tables/demodata.yml'</span><span class="p">,</span>
    <span class="n">dag</span><span class="o">=</span><span class="n">dag</span>
<span class="p">)</span>

<span class="c1"># A dummy operator to simulate data publication when the Soda SQL Scan task is successful
</span><span class="n">publish_data_op</span> <span class="o">=</span> <span class="n">DummyOperator</span><span class="p">(</span>
    <span class="n">task_id</span><span class="o">=</span><span class="s">'publish_data'</span>
<span class="p">)</span>

<span class="n">ingest_data_op</span> <span class="o">&gt;&gt;</span> <span class="n">soda_sql_scan_op</span> <span class="o">&gt;&gt;</span> <span class="n">publish_data_op</span>
</code></pre></div></div> <h2 id="prefect-using-a-custom-task"> <a href="#prefect-using-a-custom-task" class="anchor-heading" aria-labelledby="prefect-using-a-custom-task"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Prefect using a custom Task </h2> <p>Create a custom Prefect Task to run Soda SQL scans programmatically.</p> <ol> <li>Install Soda SQL and Prefect in your environment.</li> <li>Make sure that Soda SQL is available in the environment in whic your Prefect flow runs. For example, if you use Docker as the storage backend, you must provide Soda SQL as a dependency. Refer to <a href="https://docs.prefect.io/core/concepts/flows.html">Prefect documentation</a>.</li> <li>Define a custom Prefect Task to wrap Soda SQL and use it in your Prefect Flow. Refer to the following basic implementation of a SodaSQLScan Task.</li> </ol> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">sodasql.scan.scan_builder</span> <span class="kn">import</span> <span class="n">ScanBuilder</span>
<span class="kn">from</span> <span class="nn">prefect</span> <span class="kn">import</span> <span class="n">Task</span>
<span class="kn">from</span> <span class="nn">prefect.utilities.tasks</span> <span class="kn">import</span> <span class="n">defaults_from_attrs</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Union</span>
<span class="k">class</span> <span class="nc">SodaSQLScan</span><span class="p">(</span><span class="n">Task</span><span class="p">):</span>
    <span class="s">"""
    SodaSQLScan
    """</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">scan_def</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">warehouse_def</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">):</span>
        <span class="s">"""
        Args:
            scan_def: Soda SQL scan file path or dictionary
            warehouse_def: Soda SQL warehouse file path or dictionary
            **kwargs:
        """</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">scan_builder</span> <span class="o">=</span> <span class="n">ScanBuilder</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">_set_scan_def</span><span class="p">(</span><span class="n">scan_def</span><span class="o">=</span><span class="n">scan_def</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">_set_warehouse_def</span><span class="p">(</span><span class="n">warehouse_def</span><span class="o">=</span><span class="n">warehouse_def</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">().</span><span class="n">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">_set_scan_def</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scan_def</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="s">"""
        Args:
            scan_def: Soda SQL scan file path or dictionary
        Returns:
        """</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">scan_def</span> <span class="o">=</span> <span class="n">scan_def</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scan_def</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">scan_builder</span><span class="p">.</span><span class="n">scan_yml_file</span> <span class="o">=</span> <span class="n">scan_def</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scan_def</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">scan_builder</span><span class="p">.</span><span class="n">scan_yml_dict</span> <span class="o">=</span> <span class="n">scan_def</span>
            
    <span class="k">def</span> <span class="nf">_set_warehouse_def</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">warehouse_def</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="bp">None</span><span class="p">:</span>
        <span class="s">"""
        Args:
            warehouse_def: Soda SQL warehouse file path or dictionary
        Returns:
        """</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">warehouse_def</span> <span class="o">=</span> <span class="n">warehouse_def</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">warehouse_def</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">scan_builder</span><span class="p">.</span><span class="n">warehouse_yml_file</span> <span class="o">=</span> <span class="n">warehouse_def</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">warehouse_def</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">scan_builder</span><span class="p">.</span><span class="n">warehouse_yml_dict</span> <span class="o">=</span> <span class="n">warehouse_def</span>
            
    <span class="o">@</span><span class="n">defaults_from_attrs</span><span class="p">(</span><span class="s">"scan_def"</span><span class="p">,</span> <span class="s">"warehouse_def"</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scan_def</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">warehouse_def</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Dict</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
        <span class="s">"""
        Args:
            scan_def: Soda SQL scan file path or dictionary
            warehouse_def: Soda SQL warehouse file path or dictionary
        Returns: Soda SQL scan results as JSON object
        """</span>
        <span class="k">if</span> <span class="n">scan_def</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nb">ValueError</span><span class="p">(</span>
                <span class="s">"Scan definition cannot be None. </span><span class="se">\
</span><span class="s">                Please provide either a path to a scan definition file or a scan definition dictionary"</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">warehouse_def</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nb">ValueError</span><span class="p">(</span>
                <span class="s">"Warehouse definition cannot be None. </span><span class="se">\
</span><span class="s">                Please provide either a path to a warehouse definition file or a warehouse definition dictionary"</span>
            <span class="p">)</span>
        <span class="n">scan</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">scan_builder</span><span class="p">.</span><span class="n">build</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">scan</span><span class="p">.</span><span class="n">execute</span><span class="p">().</span><span class="n">to_json</span><span class="p">()</span>
</code></pre></div></div> <p>In your Prefect Flow, call the Soda SQL Task as per the following example.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">SodaSQLScan</span>

<span class="kn">from</span> <span class="nn">prefect</span> <span class="kn">import</span> <span class="n">Flow</span>


<span class="n">dq_task</span> <span class="o">=</span> <span class="n">SodaSQLScan</span><span class="p">(</span>
    <span class="n">scan_def</span><span class="o">=</span><span class="s">"/path/to/scan.yml"</span><span class="p">,</span>
    <span class="n">warehouse_def</span><span class="o">=</span><span class="s">"/path/to/warehouse.yml"</span>
<span class="p">)</span>

<span class="k">with</span> <span class="n">Flow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">"DQ Sample"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>

    <span class="n">f</span><span class="p">.</span><span class="n">add_task</span><span class="p">(</span><span class="n">dq_task</span><span class="p">)</span>

<span class="c1"># run Flow locally, useful only for debugging
# f.run()
</span>
<span class="c1"># Register flow to Prefect Server/Cloud
</span><span class="n">f</span><span class="p">.</span><span class="n">register</span><span class="p">()</span>
</code></pre></div></div> <h2 id="go-further"> <a href="#go-further" class="anchor-heading" aria-labelledby="go-further"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Go further </h2> <ul> <li>If you want to write integration instructions for your favorite data orchestration tool, please contribute to our open-source docs! <a href="https://github.com/sodadata/soda-sql/discussions">Post a note on GitHub</a> to let us know your plans.</li> <li>Need help? <a href="https://github.com/sodadata/soda-sql/discussions">Post your questions on GitHub</a> or <a href="https://join.slack.com/t/soda-community/shared_invite/zt-m77gajo1-nXJF7JtbbRht2zwaiLb9pg">join our Slack community</a></li> <li>Learn how to configure <a href="/soda-sql/documentation/programmatic_scan.html">programmatic Soda SQL scans</a>.</li> </ul> </div> </div> <div class="search-overlay"></div> </div> </body> </html>
